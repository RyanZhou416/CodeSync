name: Publish Release

on:
  push:
    branches: [ "master" ] # 如果你是 master 分支，请在这里改成 "master"
    paths: [ "VERSION" ]
    tags: [ "v*" ]
  workflow_dispatch: # 保持这个，允许手动点按钮

permissions:
  contents: write
  packages: write

jobs:
  # ===================================================
  # 1. 准备工作：读取版本号
  # ===================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Read VERSION file
        id: get_version
        run: |
          # 读取文件并去除首尾空格
          v=$(cat VERSION | xargs)
          # 如果没有 v 前缀，自动加上
          if [[ $v != v* ]]; then v="v$v"; fi
          echo "version=$v" >> $GITHUB_OUTPUT
          echo "Target Release Version: $v"

  # ===================================================
  # 2. Windows 构建
  # ===================================================
  build-windows:
    needs: prepare
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            py_arch: 'x64'
          - arch: x86
            py_arch: 'x86'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          architecture: ${{ matrix.py_arch }}
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Install Inno Setup
        run: choco install innosetup
      - name: Build EXE
        # 注意：这里添加了 VERSION 文件
        run: |
          pyinstaller --noconsole --onefile --name "CodeSync" --add-data "assets/lang.json;assets" --add-data "VERSION;." src/main.py
      - name: Compile Installer
        shell: cmd
        # 传入 MyAppVersion 确保安装包版本号正确
        run: |
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DMyOutputFilename="CodeSync_Setup_Win_${{ matrix.arch }}" /DMyAppArch="${{ matrix.arch }}" build_scripts\win_setup.iss
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: setup-windows-${{ matrix.arch }}
          path: Output/*.exe

  # ===================================================
  # 3. macOS 构建
  # ===================================================
  build-macos:
    needs: prepare
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: |
          brew install create-dmg
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build .app
        run: |
          chmod +x build_scripts/mac_build.sh
          sh build_scripts/mac_build.sh
      - name: Create DMG
        run: |
          create-dmg \
            --volname "CodeSync Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --app-drop-link 600 185 \
            "CodeSync_Mac_Universal.dmg" \
            "dist/CodeSync.app"
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dmg-macos-universal
          path: "*.dmg"

  # ===================================================
  # 4. Linux 构建
  # ===================================================
  build-linux:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build Binary
        run: |
          pyinstaller --noconsole --onefile --name "CodeSync" --add-data "assets/lang.json:assets" --add-data "VERSION:." src/main.py
          mv dist/CodeSync CodeSync_Linux_amd64.bin
      - name: Create .deb package
        run: |
          # 读取纯数字版本号 (去掉 v)
          VER=$(cat VERSION | xargs)
          
          mkdir -p deb_package/usr/local/bin
          mkdir -p deb_package/DEBIAN
          cp CodeSync_Linux_amd64.bin deb_package/usr/local/bin/codesync
          chmod +x deb_package/usr/local/bin/codesync
          
          echo "Package: codesync" > deb_package/DEBIAN/control
          echo "Version: $VER" >> deb_package/DEBIAN/control
          echo "Architecture: amd64" >> deb_package/DEBIAN/control
          echo "Maintainer: Ryan" >> deb_package/DEBIAN/control
          echo "Description: CodeSync Client" >> deb_package/DEBIAN/control
          
          dpkg-deb --build deb_package CodeSync_Linux_amd64.deb
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            *.bin
            *.deb

  # ===================================================
  # 5. Server Docker 构建
  # ===================================================
  build-docker:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/codesync-server
          # 自动打标签: latest 和 版本号(v1.0.x)
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.prepare.outputs.version }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ===================================================
  # 6. 发布 Release (整合)
  # ===================================================
  release:
    needs: [prepare, build-windows, build-macos, build-linux, build-docker]
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: setup-windows-*
          merge-multiple: true
      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dmg-macos-*
          merge-multiple: true
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-packages

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          # 使用 prepare 阶段读取到的版本号 (例如 v1.0.8) 作为标签名
          # 如果该标签不存在，它会自动创建！
          tag_name: ${{ needs.prepare.outputs.version }}
          name: Release ${{ needs.prepare.outputs.version }}
          draft: false
          prerelease: false
          files: |
            *.exe
            *.dmg
            *.bin
            *.deb
          generate_release_notes: true