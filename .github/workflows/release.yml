name: Publish Release

on:
  push:
    branches: [ "master" ]
    paths: [ "VERSION" ]
    tags: [ "v*" ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  # ===================================================
  # 1. 准备工作
  # ===================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Read VERSION file
        id: get_version
        run: |
          v=$(cat VERSION | xargs)
          if [[ $v != v* ]]; then v="v$v"; fi
          echo "version=$v" >> $GITHUB_OUTPUT
          echo "Target Version: $v"

  # ===================================================
  # 2. Windows 构建
  # ===================================================
  build-windows:
    needs: prepare
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            py_arch: 'x64'
          - arch: x86
            py_arch: 'x86'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          architecture: ${{ matrix.py_arch }}
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Install Inno Setup
        run: choco install innosetup
      - name: Build EXE
        run: |
          pyinstaller --noconsole --onefile --name "CodeSync" --paths "src" --add-data "assets/lang.json;assets" --add-data "VERSION;." src/main.py
      - name: Compile Installer
        shell: cmd
        # Windows 已经在 .iss 文件内部处理了版本号拼接，这里只需传入变量
        run: |
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DMyOutputFilename="CodeSync_Setup_Win_${{ matrix.arch }}" /DMyAppArch="${{ matrix.arch }}" build_scripts\win_setup.iss
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: setup-windows-${{ matrix.arch }}
          path: Output/*.exe

  # ===================================================
  # 3. macOS 构建
  # ===================================================
  build-macos:
    needs: prepare
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: |
          brew install create-dmg
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build .app
        run: |
          pyinstaller --noconsole --windowed --name "CodeSync" --paths "src" --add-data "assets/lang.json:assets" --add-data "VERSION:." src/main.py

      - name: Create DMG
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          DMG_NAME="CodeSync_Mac_${VERSION}_Universal.dmg"
          
          create-dmg \
            --volname "CodeSync Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --app-drop-link 600 185 \
            "$DMG_NAME" \
            "dist/CodeSync.app"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dmg-macos-universal
          path: "*.dmg"

  # ===================================================
  # 4. Linux 构建
  # ===================================================
  build-linux:
    needs: prepare
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      - name: Build Binary
        run: |
          pyinstaller --noconsole --onefile --name "CodeSync" --paths "src" --add-data "assets/lang.json:assets" --add-data "VERSION:." src/main.py
          
          # 核心修改：重命名二进制文件带版本号
          VERSION="${{ needs.prepare.outputs.version }}"
          mv dist/CodeSync "CodeSync_Linux_${VERSION}_amd64.bin"

      - name: Create .deb package
        run: |
          VER=$(cat VERSION | xargs)
          FULL_VER="${{ needs.prepare.outputs.version }}"
          
          mkdir -p deb_package/usr/local/bin
          mkdir -p deb_package/DEBIAN
          
          # 复制刚才重命名过的 bin 文件并改回通用名 codesync，方便用户输入命令
          cp "CodeSync_Linux_${FULL_VER}_amd64.bin" deb_package/usr/local/bin/codesync
          chmod +x deb_package/usr/local/bin/codesync
          
          echo "Package: codesync" > deb_package/DEBIAN/control
          echo "Version: $VER" >> deb_package/DEBIAN/control
          echo "Architecture: amd64" >> deb_package/DEBIAN/control
          echo "Maintainer: Ryan" >> deb_package/DEBIAN/control
          echo "Description: CodeSync Client" >> deb_package/DEBIAN/control
          
          # 核心修改：输出 deb 文件名带版本号
          dpkg-deb --build deb_package "CodeSync_Linux_${FULL_VER}_amd64.deb"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            *.bin
            *.deb

  # ===================================================
  # 5. Server Docker 构建
  # ===================================================
  build-docker:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/codesync-server
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.prepare.outputs.version }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ===================================================
  # 6. 发布 Release
  # ===================================================
  release:
    needs: [prepare, build-windows, build-macos, build-linux, build-docker]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: setup-windows-*
          merge-multiple: true
      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dmg-macos-*
          merge-multiple: true
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-packages

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          name: Release ${{ needs.prepare.outputs.version }}
          draft: false
          prerelease: false
          files: |
            *.exe
            *.dmg
            *.bin
            *.deb
          generate_release_notes: true