name: Publish Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  # ===================================================
  # 1. Windows 构建 (x64 和 x86)
  # ===================================================
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            py_arch: 'x64'
          - arch: x86
            py_arch: 'x86'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          architecture: ${{ matrix.py_arch }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install Inno Setup
        run: choco install innosetup

      - name: Build EXE
        run: |
          pyinstaller --noconsole --onefile --name "CodeSync" --add-data "assets/lang.json;assets" --add-data "VERSION;." src/main.py

      - name: Compile Installer (Inno Setup)
        shell: cmd
        # 这里传入了 MyAppArch 参数
        run: |
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DMyOutputFilename="CodeSync_Setup_Win_${{ matrix.arch }}" /DMyAppArch="${{ matrix.arch }}" build_scripts\win_setup.iss

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: setup-windows-${{ matrix.arch }}
          path: Output/*.exe

  # ===================================================
  # 2. macOS 构建
  # ===================================================
  build-macos:
    runs-on: macos-latest # 使用最新 mac 环境
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # 关键修复：create-dmg 是 brew 包，不是 pip 包
      - name: Install dependencies
        run: |
          brew install create-dmg
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build .app
        run: |
          # 确保脚本有执行权限
          chmod +x build_scripts/mac_build.sh
          # 直接调用我们写好的脚本
          sh build_scripts/mac_build.sh

      - name: Create DMG
        run: |
          # 确保 dist 目录存在
          ls -R dist/
          # 使用 create-dmg 打包
          create-dmg \
            --volname "CodeSync Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --app-drop-link 600 185 \
            "CodeSync_Mac_Universal.dmg" \
            "dist/CodeSync.app"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dmg-macos-universal
          path: "*.dmg"

  # ===================================================
  # 3. Linux 构建
  # ===================================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Binary
        run: |
          pyinstaller --noconsole --onefile --name "CodeSync" --add-data "assets/lang.json:assets" --add-data "VERSION:." src/main.py
          mv dist/CodeSync CodeSync_Linux_amd64.bin

      - name: Create .deb package
        run: |
          mkdir -p deb_package/usr/local/bin
          mkdir -p deb_package/DEBIAN
          cp CodeSync_Linux_amd64.bin deb_package/usr/local/bin/codesync
          chmod +x deb_package/usr/local/bin/codesync
          
          # 创建 control 文件
          echo "Package: codesync" > deb_package/DEBIAN/control
          # 处理版本号，移除 'v' 前缀
          echo "Version: $(echo ${{ github.ref_name }} | sed 's/v//')" >> deb_package/DEBIAN/control
          echo "Architecture: amd64" >> deb_package/DEBIAN/control
          echo "Maintainer: Ryan" >> deb_package/DEBIAN/control
          echo "Description: CodeSync Client" >> deb_package/DEBIAN/control
          
          dpkg-deb --build deb_package CodeSync_Linux_amd64.deb

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            *.bin
            *.deb

  # ===================================================
  # 4. Server Docker 构建
  # ===================================================
  build-docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/codesync-server

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ===================================================
  # 5. 发布 Release
  # ===================================================
  release:
    needs: [build-windows, build-macos, build-linux, build-docker]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: setup-windows-*
          merge-multiple: true

      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dmg-macos-*
          merge-multiple: true

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-packages

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.exe
            *.dmg
            *.bin
            *.deb
          generate_release_notes: true